import type { NextPage } from 'next'
import Head from 'next/head'
import Image from 'next/image'
import { useRouter } from 'next/router'

import TitleImg from '/public/images/titleImg.jpg'
import NavBar from 'src/components/NavBar'
import Tags from 'src/components/Tags'
import VideoInfo from 'src/components/VideoInfo'

import VideoFrame from 'styles/videoDetail/VideoFrameStyle'
import { ChannelInfoContainerInnerWrapper, ChannelInfoImgTextWrapper } from 'styles/channelDetail/ChannelInfoContainerStyle'
import { BadMinsim, GoodMinsim, MinsimTextWrapper, VideoMinsim, VideoMinsimContainer } from 'styles/videoDetail/VideoMinsimStyle'
import { VideoDetailContainerInnerWrapper, VideoListContainer } from 'styles/channelDetail/VideoListContainerStyle'
import { Rank1Tag, Rank2Tag, Rank3Tag } from 'styles/videoDetail/RankTagStyle'
import CommentInfo from 'src/components/CommentInfo'
import { VideoInfoContainer, VideoInfoImgTextWrapper } from 'styles/videoDetail/CommentInfoStyle'
import { useEffect, useState } from 'react'
import apiIniVideoDetail from 'src/pages/api/apiVideoDetail'
import { useQuery } from '@tanstack/react-query'
import apiIniVideoComments from 'src/pages/api/apiVideoComments'
import { ChannelTagWrapper } from 'styles/componentStyles/ChannelInfoStyle'
import { Tag } from 'styles/componentStyles/TagStyle'


interface commentData {
  content: string;
  like: number;
  minsim: string;
  name: string;
  thumbnail: string;
  time: string;
}
interface videoData {
  text: string;
  value: number;
}

const VideoDetailPage: NextPage = () => {

  const router = useRouter()
  const query = router.query
  const videoId = router.query.id?.toString();
  const [commentList, setCommentList] = useState<Array<commentData>>([])
  const [videoList, setVideoList] = useState<Array<videoData>>([])

  const {data, status} = useQuery(["videoData", videoId], ()=>{return apiIniVideoDetail(videoId)})
  const {data: commentData, status: commentStatus} = useQuery(["commentData", videoId], ()=>{return apiIniVideoComments(videoId)},
    {
      enabled: !!data // true가 되면 apiIniVideoComments를 실행한다
    }
  )

  useEffect(() => {
    setVideoList(data?.keywords.sort(((a: videoData, b: videoData) => {return b.value - a.value;})))
    setCommentList(commentData?.sort(((a: commentData, b: commentData) => {return a.like - b.like;})));
  }, [commentData])    
  
  
  if (status === "loading" || commentStatus === "loading") {
    return <span>Loading...</span>;
  }

  if (status === "error") {
    return <span>Error</span>;
  }


  
  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <NavBar />
        <VideoFrame src={`https://www.youtube.com/watch?v=${query.id}`} title=''/>
          <VideoInfoContainer>
            <ChannelInfoContainerInnerWrapper>
              <ChannelInfoImgTextWrapper>
                <VideoInfo title={`${query.title}`} sub1='아이유' sub2={`조회수 ${query.view?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')}${'\u00A0'}${'\u00A0'} |${'\u00A0'}${'\u00A0'}  ${query.time?.slice(0, 10)}`} ></VideoInfo>
              </ChannelInfoImgTextWrapper>
              <ChannelTagWrapper>
                <Tag>
                  <p>{videoList[0].text}</p>
                </Tag>
                <Tag>
                  <p>{videoList[1].text}</p>
                </Tag>
                <Tag>
                  <p>{videoList[2].text}</p>
                </Tag>
              </ChannelTagWrapper>
            </ChannelInfoContainerInnerWrapper>
          </VideoInfoContainer>

          <VideoMinsimContainer>
            <MinsimTextWrapper>
              {/* text에 값 넣기 */}
              <GoodMinsim>떡상 {data.ms.toFixed(0)}%</GoodMinsim>
              <BadMinsim>떡락 {100 - data.ms.toFixed(0)}%</BadMinsim>
            </MinsimTextWrapper>
            {/* value에 값 넣기 */}
            <VideoMinsim max={100} value={data.ms} />  
          </VideoMinsimContainer>

          <VideoListContainer>
            <h4>Best 댓글</h4>
            {commentList ? <>
              <VideoDetailContainerInnerWrapper>
                <Rank1Tag />
                <VideoInfoImgTextWrapper>
                  <Image src={commentList[9].thumbnail}  alt='댓글 작성자의 프로필 대표 이미지' width={'77px'} height={'77px'} objectFit='cover' style={{borderRadius: '50%'}} />
                  <CommentInfo name={commentList[9].name} publishedTime={commentList[9].time.slice(0, 10)} comment={commentList[9].content} liked={commentList[9].like.toString()} />
                </VideoInfoImgTextWrapper>
              </VideoDetailContainerInnerWrapper>
              <VideoDetailContainerInnerWrapper>
                <Rank2Tag />
                <VideoInfoImgTextWrapper>
                  <Image src={commentList[8].thumbnail}  alt='댓글 작성자의 프로필 대표 이미지' width={'77px'} height={'77px'} objectFit='cover' style={{borderRadius: '50%'}} />
                  <CommentInfo name={commentList[8].name} publishedTime={commentList[8].time.slice(0, 10)} comment={commentList[8].content} liked={commentList[8].like.toString()} />
                </VideoInfoImgTextWrapper>
              </VideoDetailContainerInnerWrapper>
              <VideoDetailContainerInnerWrapper>
                <Rank3Tag />
                <VideoInfoImgTextWrapper>
                <Image src={commentList[7].thumbnail}  alt='댓글 작성자의 프로필 대표 이미지' width={'77px'} height={'77px'} objectFit='cover' style={{borderRadius: '50%'}} />
                  <CommentInfo name={commentList[7].name} publishedTime={commentList[7].time.slice(0, 10)} comment={commentList[7].content} liked={commentList[7].like.toString()} />
                </VideoInfoImgTextWrapper>
              </VideoDetailContainerInnerWrapper>
            </> : <></>
            }
          </VideoListContainer>
      </main>
    </div>
  )
}

export default VideoDetailPage
